"use strict";

function init() {
    blockStuff(), $.when(getTractsInBounds(getBoundParams()), getTractData(getBoundParams(), getActionTaken($("#action-taken-selector option:selected").val()))).done(function(data1, data2) {
        var hashInfo = getHashParams(), layerInfo = getLayerType(hashInfo.category.values);
        rawGeo = data1[0], rawData = data2[0], createTractDataObj(), redrawCircles(dataStore.tracts, layerInfo.type), 
        buildKeyCircles(), $.unblockUI(), isUIBlocked = !1;
    });
}

function setMapHeight() {
    var viewportHeight = $(window).height(), warningBannerHeight = $("#warning-banner").outerHeight(), headerHeight = $("#header").outerHeight(), mapHeaderHeight = $("#map-header").outerHeight(), combinedHeadersHeight = warningBannerHeight + headerHeight + mapHeaderHeight, mapHeight = viewportHeight - combinedHeadersHeight;
    $("#map-aside").css("height", mapHeight), $("#map-container").css("height", mapHeight), 
    showDataContainer ? ($(".map-container").css({
        height: .5 * mapHeight + combinedHeadersHeight,
        overflow: "hidden"
    }), $("#map").css("height", .5 * mapHeight), $("#map-aside").css("height", .5 * mapHeight), 
    $("#data-container").css("height", .5 * mapHeight - 5), $("body").addClass("show-data")) : ($("#map-aside").css("height", mapHeight), 
    $(".map-container").css("height", "auto"), $("#map").css("height", mapHeight), $("body").removeClass("show-data"));
}

function toggleSuper(status) {
    var url = $("#download-data").data("super-download"), origUrl = $("#download-data").data("download");
    status ? ($("#lender-affiliate-list").removeClass("hidden"), $("#lender-affiliates").addClass("green-highlight"), 
    $("#download-data").attr("href", url), $("#branchSelect").prop("checked") ? $(".tooltipsy.branch-component").addClass("red-highlight") : $(".tooltipsy.branch-component").removeClass("red-highlight")) : ($("#lender-affiliate-list").addClass("hidden"), 
    $("#lender-affiliates").removeClass("green-highlight"), $("#download-data").attr("href", origUrl)), 
    addParam("lh", status), $("#superSelect").prop("checked", status);
}

function toggleBranches(status) {
    status ? (drawBranches(), $("#branchKey").removeClass("hidden"), $(".tooltipsy.branch-component").removeClass("hidden"), 
    $("#lender-branches").addClass("green-highlight")) : (layers.Branches.clearLayers(), 
    $("#branchKey").addClass("hidden"), $(".tooltipsy.branch-component").addClass("hidden"), 
    $("#lender-branches").removeClass("green-highlight")), addParam("branches", status), 
    $("#branchSelect").prop("checked", status);
}

function togglePeers(status) {
    var url = $("#download-data").data("peer-download"), origUrl = $("#download-data").data("download");
    status ? ($("#lender-peers-list").removeClass("hidden"), $("#lender-peers").addClass("green-highlight"), 
    $(".tooltipsy.peer-component").removeClass("hidden"), $("#download-data").attr("href", url)) : ($("#lender-peers-list").addClass("hidden"), 
    $("#lender-peers").removeClass("green-highlight"), $(".tooltipsy.peer-component").addClass("hidden"), 
    $("#download-data").attr("href", origUrl)), addParam("peers", status), $("#peerSelect").prop("checked", status);
}

function blockStuff() {
    return isUIBlocked === !0 ? !1 : (isUIBlocked = !0, void $.blockUI({
        css: {
            border: "none",
            padding: "15px",
            backgroundColor: "#000",
            "-webkit-border-radius": "10px",
            "-moz-border-radius": "10px",
            opacity: .5,
            color: "#fff"
        },
        message: '<img src="/static/basestyle/img/loading_white.gif" height="75px"> <h6>Loading HMDA Data</h6>',
        overlayCSS: {
            backgroundColor: "#000",
            opacity: 0,
            cursor: "wait"
        }
    }));
}

function getTractsInBounds(bounds) {
    $("#bubbles_loading").show();
    var endpoint = "/api/tractCentroids/", params = {
        neLat: bounds.neLat,
        neLon: bounds.neLon,
        swLat: bounds.swLat,
        swLon: bounds.swLon
    };
    return $.ajax({
        url: endpoint,
        data: params,
        traditional: !0,
        success: console.log("tract Get successful")
    }).fail(function(status) {
        console.log("no data was available at" + endpoint + ". status: " + status);
    });
}

function getTractData(bounds, actionTakenVal) {
    $("#bubbles_loading").show();
    var endpoint = "/api/all/", params = {
        year: 2013,
        lh: !1,
        peers: !1,
        neLat: bounds.neLat,
        neLon: bounds.neLon,
        swLat: bounds.swLat,
        swLon: bounds.swLon
    }, hash = getHashParams();
    return "undefined" != typeof hash.lh && (params.lh = hash.lh.values), "undefined" != typeof hash.peers && (params.peers = hash.peers.values), 
    urlParam("year") && (params.year = urlParam("year")), urlParam("metro") ? params.metro = urlParam("metro") : console.log("No metro area provided"), 
    urlParam("lender") ? (params.lender = urlParam("lender"), actionTakenVal ? params.action_taken = actionTakenVal : console.log("No action taken value - default (1-5) will be used."), 
    $.ajax({
        url: endpoint,
        data: params,
        traditional: !0,
        success: console.log("get API All Data request successful")
    }).fail(function(status) {
        console.log("no data was available at" + endpoint + ". status: " + status);
    })) : (console.log(" Lender parameter is required."), !1);
}

function createTractDataObj(callback) {
    dataStore.tracts = {}, _.each(rawGeo.features, function(feature) {
        var geoid = feature.properties.geoid;
        dataStore.tracts[geoid] = feature.properties, _.extend(dataStore.tracts[geoid], rawData.minority[geoid]), 
        "undefined" != typeof rawData.loanVolume[geoid] ? _.extend(dataStore.tracts[geoid], rawData.loanVolume[geoid]) : dataStore.tracts[geoid].volume = 0;
    }), "function" == typeof callback && callback() && callback();
}

function getBranchesInBounds(bounds) {
    var endpoint = "/api/branchLocations/", params = {
        neLat: bounds.neLat,
        neLon: bounds.neLon,
        swLat: bounds.swLat,
        swLon: bounds.swLon
    };
    return urlParam("lender") ? (params.lender = urlParam("lender"), $.ajax({
        url: endpoint,
        data: params,
        traditional: !0,
        success: console.log("Branch Location Get successful")
    }).fail(function(status) {
        console.log("no data was available at" + endpoint + ". status: " + status);
    })) : (console.log(" Lender parameter is required."), !1);
}

function drawBranches() {
    $.when(getBranchesInBounds(getBoundParams())).then(function(branches) {
        $.each(branches.features, function(i, val) {
            drawMarker(val.properties);
        });
    });
}

function redrawCircles(geoData, layerType) {
    $("#bubbles_loading").show(), layers.Centroids.clearLayers(), _.each(geoData, function(geo) {
        drawCircle(geo, layerType);
    });
}

function updateCircles(layerType) {
    layers.Centroids.eachLayer(function(layer) {
        if (0 === layer.volume) return !1;
        if ("minority" === layerType) {
            var newStyle = {};
            _.extend(newStyle, baseStyle), newStyle.fillColor = updateMinorityCircleFill(layer.geoid), 
            layer.setStyle(newStyle);
        } else "seq" === layerType && layer.setStyle(seqBaseStyle);
    }), console.log("color update complete.");
}

function drawCircle(geo, layerType, options) {
    var style, data = geo;
    style = 0 === geo.total_pop || 0 === geo.volume ? noStyle : "seq" === layerType ? seqBaseStyle : minorityContinuousStyle(geo, baseStyle);
    var circle = L.circle([ geo.centlat, geo.centlon ], hmdaStat(data), style);
    circle.geoid = geo.geoid, circle.volume = geo.volume, circle.type = "tract-circle", 
    circle.keyCircle = 0, "undefined" != typeof options && (circle.keyCircle = options.keyCircle, 
    console.log("geo: ", geo)), circle.on("mouseover mousemove", function(e) {
        var hisp, white, black, asian;
        hisp = (100 * data.hispanic_perc).toFixed(2), white = (100 * data.non_hisp_white_only_perc).toFixed(2), 
        black = (100 * data.non_hisp_black_only_perc).toFixed(2), asian = (100 * data.non_hisp_asian_only_perc).toFixed(2), 
        new L.Rrose({
            offset: new L.Point(0, 0),
            closeButton: !1,
            autoPan: !1,
            y_bound: 160
        }).setContent('<div class="bubble-header"><b>Tract ' + circle.geoid + "<br/>" + data.volume + "</b> LAR | <b>" + data.num_households + '</b> HHs</div><div class="bubble-label"><b>Hispanic</b>: (' + hisp + '%)</div><div class="css-chart"><div class="css-chart-inner" data-min=' + hisp + '></div></div><div class="bubble-label"><b>Black</b>: (' + black + '%)</div><div class="css-chart"><div class="css-chart-inner" data-min=' + black + '></div></div><div class="bubble-label"><b>Asian</b>: (' + asian + '%)</div><div class="css-chart"><div class="css-chart-inner" data-min=' + asian + '></div></div><div class="bubble-label"><b>White</b>: (' + white + '%)</div><div class="css-chart"><div class="css-chart-inner" data-min=' + white + "></div></div>").setLatLng(e.latlng).openOn(map), 
        $(".css-chart-inner").each(function() {
            var self = $(this), width = self.data("min") / 100 * 120, widthStr = width.toString() + "px";
            self.css("width", widthStr), self.css("background-color", "#000");
        });
    }), circle.on("mouseout", function() {
        map.closePopup();
    }), layers.Centroids.addLayer(circle);
}

function drawMarker(data) {
    var myIcon = L.icon({
        iconUrl: "/static/basestyle/img/branch-marker_off.png",
        iconSize: [ 8, 8 ]
    }), myIconHover = L.icon({
        iconUrl: "/static/basestyle/img/branch-marker_on.png",
        iconSize: [ 8, 8 ]
    }), marker = L.marker([ data.lat, data.lon ], {
        icon: myIcon
    });
    marker.on("mouseover mousemove", function(e) {
        this.setIcon(myIconHover), new L.Rrose({
            offset: new L.Point(0, 0),
            closeButton: !1,
            autoPan: !1
        }).setContent('<div class="branch-marker">' + data.name + "<br/>" + data.city).setLatLng(e.latlng).openOn(map);
    }), marker.on("mouseout", function() {
        this.setIcon(myIcon), map.closePopup();
    }), layers.Branches.addLayer(marker);
}

function minorityContinuousStyle(geoProps, baseStyle) {
    return minorityStyle(geoProps, function(minorityPercent, bucket) {
        return (minorityPercent - bucket.lowerBound) / bucket.span;
    }, baseStyle);
}

function minorityStyle(geoProps, percentFn, baseStyle) {
    var geoid = geoProps.geoid, tract = dataStore.tracts[geoid];
    if (0 === tract.total_pop || 0 === tract.volume) return noStyle;
    var perc = minorityPercent(tract), bucket = toBucket(perc), bucketPercent = percentFn(perc, bucket);
    return $.extend({}, baseStyle, {
        fillColor: colorFromPercent(bucketPercent, bucket.colors)
    });
}

function updateMinorityCircleFill(geoid) {
    var tract = dataStore.tracts[geoid];
    if (0 === tract.total_pop || 0 === tract.volume) return noStyle;
    var perc = minorityPercent(tract), bucket = toBucket(perc), bucketPercent = percentFn(perc, bucket);
    return colorFromPercent(bucketPercent, bucket.colors);
}

function percentFn(minorityPercent, bucket) {
    return (minorityPercent - bucket.lowerBound) / bucket.span;
}

function minorityPercent(tractData) {
    var fieldName = $("#category-selector option:selected").val();
    return "inv_" === fieldName.substring(0, 4) ? 1 - tractData[fieldName.substr(4)] : tractData[fieldName];
}

function toBucket(percent) {
    var i, len = colorRanges.length;
    for (i = 0; len - 1 > i; i++) if (colorRanges[i + 1].lowerBound > percent) return colorRanges[i];
    return colorRanges[len - 1];
}

function colorFromPercent(percent, c) {
    var diffR = (c.highR - c.lowR) * percent, diffG = (c.highG - c.lowG) * percent, diffB = (c.highB - c.lowB) * percent;
    return "rgb(" + (c.lowR + diffR).toFixed() + ", " + (c.lowG + diffG).toFixed() + ", " + (c.lowB + diffB).toFixed() + ")";
}

function hmdaStat(tractData) {
    var $selected = $("#action-taken-selector option:selected"), scale = ($selected.val(), 
    $selected.data("scale")), area = scale * tractData.volume;
    return Math.round(Math.sqrt(area));
}

function getLayerType(layer) {
    var type;
    switch (layer) {
      case "inv_non_hisp_white_only_perc":
        layer = layers.PctMinority, type = "minority";
        break;

      case "hispanic_perc":
        layer = layers.PctHispanic, type = "minority";
        break;

      case "non_hisp_black_only_perc":
        layer = layers.PctBlack, type = "minority";
        break;

      case "non_hisp_asian_only_perc":
        layer = layers.PctAsian, type = "minority";
        break;

      case "non_hisp_white_only_perc":
        layer = layers.PctNonWhite, type = "minority";
        break;

      case "sequential3":
        layer = layers.Sequential3, type = "seq";
        break;

      case "sequential10":
        layer = layers.Sequential10, type = "seq";
        break;

      case "plurality":
        layer = layers.Plurality, type = "seq";
    }
    return {
        type: type,
        layer: layer
    };
}

function layerUpdate(layer) {
    var layerEval, mbLayer, layerType, keyPath;
    if (!layer) return console.log("The layer you've requested does not exist."), !1;
    for (var i = minorityLayers.length - 1; i >= 0; i--) map.removeLayer(minorityLayers[i]);
    switch (layer) {
      case "sequential3":
        keyPath = "/static/basestyle/img/fl_color-ramp_seq-03.png";
        break;

      case "sequential10":
        keyPath = "/static/basestyle/img/fl_color-ramp_seq-10.png";
        break;

      case "plurality":
        keyPath = "/static/basestyle/img/fl_color-ramp_plurality.png";
        break;

      case "default":
        keyPath = !1;
    }
    keyPath ? ($("#altScaleImg").attr("src", keyPath), $("#altScale").removeClass("hidden"), 
    $("#scale").addClass("hidden")) : ($("#altScale").addClass("hidden"), $("#scale").removeClass("hidden")), 
    layerEval = getLayerType(layer), mbLayer = layerEval.layer, layerType = layerEval.type, 
    map.addLayer(mbLayer), mbLayer.bringToFront(), layers.Water.bringToFront(), layers.Boundaries.bringToFront(), 
    layers.MSALabels.bringToFront(), map.hasLayer(layers.CountyLabels) && layers.CountyLabels.bringToFront(), 
    addParam("category", $("#category-selector option:selected").val()), updateCircles(layerType);
}

function urlParam(field) {
    var url = window.location.search.replace("?", ""), keyValueStrs = url.split("&"), pairs = _.map(keyValueStrs, function(keyValueStr) {
        return keyValueStr.split("=");
    }), params = _.reduce(pairs, function(soFar, pair) {
        return 2 === pair.length && (soFar[pair[0]] = pair[1]), soFar;
    }, {});
    return params[field];
}

function updatePrintLink() {
    $("#printLink").attr("href", "/map/print" + window.location.search + window.location.hash);
}

function updateCensusLink() {
    var actions = getHashParams(), actionVar = getActionTaken(actions.action.values);
    $("#downloadCensus").attr("href", "/census/race_summary_csv/?metro=" + urlParam("metro") + "&lender=" + urlParam("lender") + "&action_taken=" + actionVar);
}

function getActionTaken(value) {
    var actionTaken;
    switch (value) {
      case "all-apps-5":
        actionTaken = "1,2,3,4,5";
        break;

      case "all-apps-6":
        actionTaken = "1,2,3,4,5,6";
        break;

      case "originations-1":
        actionTaken = "1";
    }
    return actionTaken;
}

function getBoundParams() {
    var bounds = map.getBounds(), padding = 0;
    return {
        neLat: (bounds._northEast.lat + padding).toFixed(6),
        neLon: (bounds._northEast.lng + padding).toFixed(6),
        swLat: (bounds._southWest.lat - padding).toFixed(6),
        swLon: (bounds._southWest.lng - padding).toFixed(6)
    };
}

function getUniques(arr) {
    return _.uniq(arr);
}

function buildKeyCircles() {
    var selector = (getHashParams(), $("#keySvg"));
    selector.html("");
    var circles = getRange(map._layers);
    if (0 === circles.length) return !1;
    for (var $scale = $("#action-taken-selector option:selected"), posx = ($scale.data("scale"), 
    0), rad = 0, maxRad = _.max(circles, function(circleObj) {
        return circleObj._radius;
    })._radius, posy = 2 * maxRad, textPosy = posy + 16, svgStr = '<svg height="' + (2 * maxRad + 20) + '">', i = 0; i < circles.length; i++) {
        var circle = circles[i];
        rad = circle._radius, console.log("RAD: ", rad), posx += 45, svgStr += '<circle cx="' + posx + '" cy="' + (posy - rad) + '" r="' + rad + '" fillColor="#111111" fill-opacity=".7" stroke=true color="#333", opacity=1/>', 
        svgStr += '<text x="' + posx + '" y="' + textPosy + '" font-size="1em" text-anchor="middle">' + circle.volume + "</text>";
    }
    svgStr += "</svg>", selector.html(svgStr);
}

function getRange(data) {
    var circles = _.matches({
        type: "tract-circle"
    }), circleFilter = _.filter(data, circles);
    if (0 === circleFilter.length) return [];
    var keyCircles, keyCirclesFilter, valArray, max = _.max(data, function(circleObj) {
        return circleObj._mRadius;
    }), min = _.min(data, function(circleObj) {
        return circleObj._mRadius;
    }), multiple = (max.volume - min.volume) / 3, drawNewArray = [ min.volume + multiple, min.volume + 2 * multiple ];
    return max.volume <= 10 ? valArray = [ min, max ] : 0 === min.volume ? (min = {
        volume: 1
    }, drawNewArray = [ min.volume, min.volume + multiple, min.volume + 2 * multiple ], 
    _.each(drawNewArray, function(val) {
        addKeyLayerCircle(val);
    }), keyCircles = _.matches({
        keyCircle: 1
    }), keyCirclesFilter = _.filter(data, keyCircles), valArray = [ keyCirclesFilter[0], keyCirclesFilter[1], keyCirclesFilter[2], max ]) : (_.each(drawNewArray, function(val) {
        addKeyLayerCircle(val);
    }), keyCircles = _.matches({
        keyCircle: 1
    }), keyCirclesFilter = _.filter(data, keyCircles), valArray = [ min, keyCirclesFilter[0], keyCirclesFilter[1], max ]), 
    valArray;
}

function addKeyLayerCircle(volume) {
    var geo = {
        volume: Math.round(volume),
        centlat: map.getCenter().lat,
        centlon: 1
    }, options = {
        keyCircle: 1
    };
    drawCircle(geo, "seq", options);
}

window.console || (console = {
    log: function() {}
});

var showDataContainer;

$(document).ready(function() {
    var lhStatus, peerStatus, branchStatus;
    $(".tabs").show(), $(window).resize(function() {
        setMapHeight();
    }), $("#category-selector").on("change", function() {
        var val = $("#category-selector").val();
        layerUpdate(val);
    }), "undefined" != typeof loadParams.category ? ($("#category-selector").val(loadParams.category.values), 
    layerUpdate(loadParams.category.values)) : (addParam("category", "inv_non_hisp_white_only_perc"), 
    layerUpdate("inv_non_hisp_white_only_perc")), "undefined" != typeof loadParams.action ? $("#action-taken-selector").val(loadParams.action.values) : addParam("action", "all-apps-5"), 
    "undefined" != typeof loadParams.lh ? (lhStatus = "true" === loadParams.lh.values, 
    $("#superSelect").prop("checked", lhStatus), $("#peerSelect").prop("disabled", lhStatus), 
    toggleSuper(lhStatus)) : addParam("lh", !1), $("#superSelect").change(function() {
        var el = $("#superSelect"), status = el.prop("checked");
        toggleSuper(status), $("#peerSelect").prop("disabled", status), init();
    }), "undefined" != typeof loadParams.branches ? (branchStatus = "true" === loadParams.branches.values, 
    $("#branchSelect").prop("checked", branchStatus), toggleBranches(branchStatus)) : addParam("branches", !1), 
    $("#branchSelect").change(function() {
        var el = $("#branchSelect"), status = el.prop("checked");
        toggleBranches(status);
    }), "undefined" != typeof loadParams.peers ? lhStatus === !0 ? ($("#peerSelect").prop("checked", !1), 
    console.log("Peer and Hierarchy cannot be checked at the same time. Unchecking Peers.")) : (peerStatus = "true" === loadParams.peers.values, 
    $("#peerSelect").prop("checked", peerStatus), $("#superSelect").prop("disabled", peerStatus), 
    togglePeers(peerStatus)) : addParam("peers", !1), $("#peerSelect").change(function() {
        var el = $("#peerSelect"), status = el.prop("checked");
        togglePeers(status), $("#superSelect").prop("disabled", status), init();
    }), $("#action-taken-selector").on("change", function() {
        addParam("action", $("#action-taken-selector option:selected").val()), init();
    }), $(".tooltipsy").tooltipsy({
        className: "bubbletooltip_tip",
        offset: [ 10, 0 ],
        show: function(e, $el) {
            $el.fadeIn(100);
        },
        hide: function(e, $el) {
            $el.fadeOut(450);
        }
    }), map.on("moveend", function() {
        $("#branchSelect").prop("checked") && toggleBranches(!0);
    }), map.on("moveend", _.debounce(init, 500)), updatePrintLink(), updateCensusLink(), 
    layerUpdate($("#category-selector").val()), $(window).on("hashchange", function() {
        updatePrintLink(), updateCensusLink();
    }), init();
});

var rawGeo, rawLar, rawMinority, rawData, isUIBlocked = !1, dataStore = {};

dataStore.tracts = {};

var baseStyle = {
    fillOpacity: .9,
    weight: .5,
    className: "lar-circle",
    fillColor: "#333"
}, seqBaseStyle = {
    fillOpacity: .7,
    weight: .75,
    className: "lar-circle seq-circle",
    fillColor: "#111111",
    stroke: !0,
    color: "#333",
    opacity: 1
}, noStyle = {
    stroke: !1,
    weight: 0,
    fill: !1
}, colorRanges = [ {
    span: .5,
    lowerBound: 0,
    colors: {
        lowR: 107,
        lowG: 40,
        lowB: 10,
        highR: 250,
        highG: 186,
        highB: 106
    }
}, {
    span: .5,
    lowerBound: .5,
    colors: {
        lowR: 124,
        lowG: 198,
        lowB: 186,
        highR: 12,
        highG: 48,
        highB: 97
    }
} ];